<!DOCTYPE html>
<html lang="en">
  <head>
    <div th:replace="fragments/common :: scripts"></div>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>calendar</title>

    <link rel="stylesheet" href="css/calendar.css" />

    <!-- fullcalendar -->
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.8/index.global.min.js"></script>
  </head>
  <body>
    <div th:replace="fragments/common :: header"></div>
    <div class="container">
      <div class="rounded" id="toast" hidden></div>
      <div class="row">
        <div class="col-lg-9">
          <img id="trash-can" src="https://i.imgur.com/UhIG0fh.png" hidden />
          <div id="calendar"></div>
        </div>

        <div class="modal fade" id="event-modal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="event-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form enctype="multipart/form-data">
                  <label class="col-form-label">ë‚ ì§œ</label>
                  <div class="md-3">
                    <input class="form-control event-date" type="date" />
                  </div>
                  <label class="col-form-label">ì¦ìƒ</label>
                  <div class="md-3">
                    <textarea class="form-control event-content"></textarea>
                  </div>
                  <label class="col-form-label">ì‚¬ì§„</label>
                  <div class="md-3 event-file-container">
                    <div class="d-flex mt-1">
                      <input class="form-control file-input" type="file" name="image" accept="image/*" />
                      <input class="btn btn-success add-btn ms-1" type="button" value="ì¶”ê°€" />
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary submit-btn">ì €ì¥í•˜ê¸°</button>
              </div>
            </div>
            <div class="row" id="preview-container"></div>
          </div>
        </div>

        <div class="modal fade" id="export-modal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="export-title">PDFë¡œ ì¶œë ¥í•˜ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form>
                  <div class="md-3">
                    <label class="col-form-label">ì‹œì‘ ë‚ ì§œ</label>
                    <input type="date" class="form-control start-date" />
                  </div>
                  <div class="md-3">
                    <label class="col-form-label">ë ë‚ ì§œ</label>
                    <input type="date" class="form-control end-date" />
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-success export-btn">ì¶œë ¥í•˜ê¸°</button>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-3 d-flex align-items-center">
          <div class="row" id="draggable">
            <div class="col d-flex justify-content-center align-items-center flex-column border rounded m-1 p-3 draggable-item" th:each="category : ${categories}" th:id="|category-${category.getUnqId()}|">
              <img class="category-imgs" th:src="${category.getImgUrl()}" />
              <span th:text="${category.getName()}"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div th:replace="fragments/common :: footer"></div>
    <script type="text/javascript">
      $(document).ready(function () {
        /** @type {DateConstructor} toISOString() ì‚¬ìš© ì‹œ ì¶œë ¥ë˜ëŠ” í•˜ë£¨ ì „ ë‚ ì§œë¥¼ ë°”ë¡œì¡ëŠ” ì˜¤í”„ì…‹ */
        const offset = new Date().getTimezoneOffset() * 60000;

        /** @type {HTMLElement} ìº˜ë¦°ë” HTML ìš”ì†Œ */
        const calendarEl = $("#calendar")[0];

        /** í’€ìº˜ë¦°ë” ì™¸ë¶€ ì´ë²¤íŠ¸ ìƒì„± ê°ì²´ */
        const Draggable = FullCalendar.Interaction.Draggable;

        /** @type {HTMLElement} ìº˜ë¦°ë”ì˜ ì™¸ë¶€ ì´ë²¤íŠ¸ HTML ìš”ì†Œ */
        const draggableEl = $("#draggable")[0];

        /** @type {HTMLElement} ì´ë²¤íŠ¸ ì‚­ì œ HTML ìš”ì†Œ */
        const trashCan = $("#trash-can");

        /**
         * ë‚´ë¶€ ì´ë²¤íŠ¸ Drag & Drop ì‹œ, object ìš”ì†Œì™€ ê²¹ì³ìˆìœ¼ë©´ true ë°˜í™˜
         * @param object í´ë¦­ ì¢Œí‘œì™€ ê°™ì€ í•˜ìœ„ ìˆ˜ì¤€ ì •ë³´ê°€ í¬í•¨ëœ ê¸°ë³¸ JavaScript ì´ë²¤íŠ¸
         * @param jsEvent í´ë¦­ ì¢Œí‘œì™€ ê°™ì€ í•˜ìœ„ ìˆ˜ì¤€ ì •ë³´ê°€ í¬í•¨ëœ ê¸°ë³¸ JavaScript ì´ë²¤íŠ¸
         */
        const isElOverObject = function (object, jsEvent) {
          let ofs = object.offset();

          let x1 = ofs.left;
          let x2 = ofs.left + object.outerWidth(true);
          let y1 = ofs.top;
          let y2 = ofs.top + object.outerHeight(true);

          return jsEvent.pageX >= x1 && jsEvent.pageX <= x2 && jsEvent.pageY >= y1 && jsEvent.pageY <= y2;
        };

        /**
         * ë§ˆìš°ìŠ¤ë¥¼ ê°–ë‹¤ëŒ€ë©´ 1.1ë°° ë˜ëŠ” í•¨ìˆ˜
         * @param elementSelector ì…€ë ‰í„°
         */
        function addHoverEffect(elementSelector) {
          $(elementSelector).on("mouseenter", function () {
            this.classList.add("external-event-hover");
          });

          $(elementSelector).on("mouseleave", function () {
            this.classList.remove("external-event-hover");
          });
        }

        /**
         * ì•Œë¦¼ì°½ ë„ìš°ê¸°
         * @param message ì•Œë¦¼ì°½ì— ë„ìš¸ ë©”ì‹œì§€
         */
        function showToast(message) {
          let toast = $("#toast");
          toast.attr("hidden", false);
          toast.html(message);
          setTimeout(function () {
            toast.attr("hidden", true);
          }, 3000);
        }

        // íŒŒì¼ ì‚­ì œ ì²˜ë¦¬ìš© ìµëª… í•¨ìˆ˜
        const removeFileId = (function () {
          const ids = [];
          return {
            add(id) {
              if (ids.includes(id)) {
                return false;
              }
              ids.push(id);
            },
            getAll() {
              return ids;
            },
          };
        })();

        //#region ëª¨ë‹¬ í•¨ìˆ˜
        /**
         * ëª¨ë‹¬ ì† í•„ë“œ ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
         * ë‚ ì§œ í•„ë“œì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•˜ê³  ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš° ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         *
         * @param {string} inputSelector - ìœ íš¨ì„± ê²€ì‚¬ ëŒ€ìƒ ë° ì˜¤ë¥˜ë¥¼ í‘œì‹œí•  ì…ë ¥ í•„ë“œ CSS ì…€ë ‰í„° (class)
         * @param {string} feedbackId - ë©”ì‹œì§€ë¥¼ í‘œì‹œí•  div í•„ë“œ CSS ì…€ë ‰í„° (id)
         * @param {string} errorMessage - ì‹¤íŒ¨í•  ê²½ìš° í‘œì‹œë˜ëŠ” ì˜¤ë¥˜ ë©”ì‹œì§€
         *
         * @returns {boolean} - ë‚ ì§œê°€ ìœ íš¨í•˜ë©´ trueë¥¼ ë°˜í™˜í•˜ê³ , ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ falseë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
         */
        function validateDateField(inputSelector, errorMessage) {
          if (!inputSelector.val()) {
            inputSelector.addClass("is-invalid");
            if (!$(".invalid-feedback").length) {
              inputSelector.after(`<div class='invalid-feedback'>${errorMessage}</div>`);
            }
            return false;
          } else {
            inputSelector.removeClass("is-invalid");
            $(".invalid-feedback").remove();
          }

          return true;
        }

        /**
         * ì‚½ì… ë° ìˆ˜ì • ë¡œì§
         */
        function eventSubmit(modal, id, start, content, insert) {
          if (!validateDateField(start, "ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")) {
            return;
          }
          if (!content.val()) {
            if (!confirm("ì¦ìƒ ê¸°ë¡ ì—†ì´ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
              return;
            }
          }
          let data = new FormData();
          data.append("postDate", start.val());
          data.append("content", content.val());

          let imageFileInputs = $(".file-input");

          for (let i = 0; i < imageFileInputs.length; i++) {
            let file = imageFileInputs[i].files[0];
            if (file) {
              data.append("files", file);
            }
          }

          let removeFileIds = removeFileId.getAll();
          for (let i = 0; i < removeFileIds.length; i++) {
            data.append("removeFileIds", removeFileIds[i]);
          }

          $.ajax({
            url: insert ? "/calendar/event/" + id : "/calendar/update/" + id,
            method: insert ? "POST" : "PUT",
            processData: false,
            contentType: false,
            data: data,
            success: (response) => {
              if (response.success) {
                calendar.refetchEvents();
                modal.modal("hide");
                showToast("ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
              } else {
                modal.modal("hide");
                showToast("ì„œë²„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              }
            },
            error: (error) => {
              calendar.refetchEvents();
              modal.modal("hide");
              showToast("ìš”ì²­ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            },
          });
        }

        let originExportModal = $("#export-modal").clone();
        let originEventModal = $("#event-modal").clone();

        $(document).on("hide.bs.modal", "#export-modal", function (e) {
          console.log("ğŸš€ ~ export-modal hide.bs.modal");
          $(this).replaceWith(originExportModal.clone());
        });

        $(document).on("hide.bs.modal", "#event-modal", function (e) {
          console.log("ğŸš€ ~ event-modal hide.bs.modal");
          $(this).replaceWith(originEventModal.clone());
        });

        $(document).on("hidden.bs.modal", "#event-modal", function (e) {
          console.log("ğŸš€ ~ event-modal hidden.bs.modal:");
        });

        $(document).on("show.bs.modal", "#event-modal", function (e) {
          console.log("ğŸš€ ~ event-modal show.bs.modal");
        });

        $(document).on("shown.bs.modal", "#event-modal", function (e) {
          console.log("ğŸš€ ~ event-modal shown.bs.modal");
        });

        //#endregion

        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          themeSystem: "bootstrap5",
          droppable: true,
          eventStartEditable: true,
          locale: "ko",
          googleCalendarApiKey: "AIzaSyBtgk1SVteetnW1M5HJcNL4hCqeecJ_x4M",
          headerToolbar: {
            left: "exportButton",
            center: "title",
            right: "today prev,next",
          },
          buttonText: {
            today: "ì˜¤ëŠ˜",
          },
          eventSources: [
            {
              url: "/calendar/event",
              method: "GET",
              failure: function () {
                alert("ì´ë²¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              },
            },
            {
              googleCalendarId: "ko.south_korea#holiday@group.v.calendar.google.com",
              className: "gcal-event",
            },
          ],
          customButtons: {
            exportButton: {
              text: "ì¶œë ¥í•˜ê¸°",
              click: function () {
                let today = new Date().toISOString().split("T")[0];
                let modal = new bootstrap.Modal($("#export-modal"));

                $(modal._element).on("shown.bs.modal", function (e) {
                  $(e.target).on("click", ".export-btn", () => {
                    let startDate = $(this).find(".start-date");
                    let endDate = $(this).find(".end-date");
                    if (!validateDateField(startDate, "ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")) return;
                    if (!validateDateField(endDate, "ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")) return;

                    // jsPDF
                    $.getJSON("/calendar/event", function (data) {
                      // startDateë¶€í„° endDate ì‚¬ì´ì˜ ë‚ ì§œë¡œ í•„í„°ë§
                      let filteredData = data.filter(function (item) {
                        let date = new Date(item.start);
                        return date >= new Date(startDate.val()) && date <= new Date(endDate.val());
                      });

                      // í•„í„°ë§ëœ ë‚ ì§œë¥¼ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
                      filteredData.sort((a, b) => new Date(b.start) - new Date(a.start));

                      // jsPDF ìƒì„±
                      const doc = new jspdf.jsPDF("p", "mm", "a4");

                      // í°íŠ¸ ì½ì–´ì˜¤ê¸°
                      fetch("/font/malgun.txt")
                        .then((data) => data.text())
                        .then((text) => {
                          doc.addFileToVFS("malgun.ttf", text);
                          doc.addFont("malgun.ttf", "malgun", "normal");
                          doc.setFont("malgun");

                          let columns = ["ë‚ ì§œ", "ëŒ€ë¶„ë¥˜", "ì¦ìƒ"];

                          // í•„í„°ë§ ëœ ë°ì´í„°ë¡œ í–‰ ìƒì„±í•˜ê¸°
                          let rows = filteredData.map(function (item) {
                            return [item.start, item.title, item.content];
                          });

                          // í…Œì´ë¸” ìƒì„±
                          doc.autoTable({
                            theme: "grid",
                            startY: 30,
                            head: [columns],
                            body: rows,
                            columnStyles: {
                              0: { cellWidth: 24 },
                              1: { cellWidth: 20 },
                              2: { cellWidth: "auto" },
                            },
                            styles: {
                              font: "malgun",
                              fontStyle: "normal",
                            },
                            didDrawPage: function (data) {
                              doc.setFontSize(18);

                              // í˜ì´ì§€ë§ˆë‹¤ í—¤ë” ë° í‘¸í„° ì„¤ì •
                              if (typeof doc.putTotalPages === "function") {
                                doc.text("ì¦ìƒì¼ê¸°", data.settings.margin.left, 22);
                                let str = "From " + startDate.val() + " to " + endDate.val();
                                if (typeof doc.putTotalPages === "function") {
                                  str = str + ", Page " + data.pageCount;
                                }

                                let pageSize = doc.internal.pageSize;
                                let pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();

                                doc.setFontSize(12);
                                doc.text(str, data.settings.margin.left, pageHeight - 10);
                              }
                            },
                          });

                          // ì €ì¥
                          doc.save(`${startDate.val()}-to-${endDate.val()}.pdf`);
                        });
                    });
                  });
                });
                modal.show();
              },
            },
          },
          // EVENT READ
          eventClick: function (info) {
            let id = info.event.id;

            const modal = new bootstrap.Modal($("#event-modal"));
            // ë°ì´í„° ê°€ì ¸ì™€ì„œ ëª¨ë‹¬ì— ë„£ê¸°
            $.getJSON("calendar/event/" + id, function (data) {
              $(modal._element).on("shown.bs.modal", function (e) {
                $(".event-title").text(data.categoryName);
                $(".event-date").val(data.postDate);
                $(".event-content").val(data.content);

                // TODO íŒŒì¼ ë³´ì´ê²Œ í•˜ê¸°
                $.getJSON("/event/" + id + "/files", function (data) {
                  $.each(data, function (index, file) {
                    $("<div>", { class: "d-flex mt-1" })
                      .append($("<input>").addClass("form-control file-read-input").attr({ type: "text", readonly: true, value: file.originName, "data-unqid": file.unqId }))
                      .append($("<input>").addClass("btn btn-secondary download-btn ms-1").attr({ type: "button", value: "ë‹¤ìš´ë¡œë“œ" }))
                      .append($("<input>").addClass("btn btn-danger remove-btn ms-1").attr({ type: "button", value: "ì‚­ì œ" }))
                      .appendTo(".event-file-container");
                  });

                  // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë¡œì§
                  $(e.target)
                    .on("click", ".download-btn", function () {
                      let id = $(this).prevAll(".file-read-input").data("unqid");

                      $.getJSON("/files/download/" + id, function (data) {
                        $("<a>", {
                          href: "data:image/*;base64," + data.imageData,
                          download: data.originName,
                        })
                          .appendTo("body")[0]
                          .click();

                        $("a[download]").remove();
                      });
                    })
                    .on("click", ".remove-btn", function () {
                      let id = $(this).prevAll(".file-read-input").data("unqid");

                      if (confirm("íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        removeFileId.add(id);
                        alert("ë³€ê²½ì‚¬í•­ì„ ì ìš©í•˜ì‹œë ¤ë©´ 'ì €ì¥í•˜ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
                        $(this).parent().remove();
                      }
                    });
                });

                // ìˆ˜ì • ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                $(e.target).on("click", ".submit-btn", () => {
                  if (!validateDateField($(".event-date"), "ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")) return;

                  // ë°ì´í„° ë‹´ê¸°
                  let data = new FormData();
                  data.append("postDate", $(".event-date").val());
                  data.append("content", $(".event-content").val());

                  // íŒŒì¼ ì²˜ë¦¬
                  let fileInputs = $(".file-input");

                  for (let i = 0; i < fileInputs.length; i++) {
                    let file = fileInputs[i].files[0];
                    if (file) {
                      data.append("files", file);
                    }
                  }

                  // íŒŒì¼ ì‚­ì œ ì²˜ë¦¬
                  let removeFileIds = removeFileId.getAll();

                  for (let i = 0; i < removeFileIds.length; i++) {
                    data.append("removeFileIds", removeFileIds[i]);
                  }

                  $.ajax({
                    url: "/calendar/update/" + id,
                    method: "PUT",
                    processData: false,
                    contentType: false,
                    data: data,
                    success: (response) => {
                      if (response.success) {
                        calendar.refetchEvents();
                        modal.hide();
                        showToast("ì´ë²¤íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                      } else {
                        modal.hide();
                        showToast("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                      }
                    },
                    error: (error) => {
                      calendar.refetchEvents();
                      modal.hide();
                      showToast("ì „ë‹¬ ë° ìš”ì²­ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    },
                  });
                });
              });
              modal.show();
            });
          },
          eventMouseEnter: function (info) {},
          eventMouseLeave: function (info) {},
          eventDragStart: function (info) {
            trashCan.attr("hidden", false);
          },
          eventDragStop: function (info) {
            info.el.classList.remove("event-hover");
            if (isElOverObject(trashCan, info.jsEvent)) {
              if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                let id = info.event.id;
                $.ajax({
                  url: "/calendar/delete/" + id,
                  method: "DELETE",
                  success: function (response) {
                    if (response.success) {
                      calendar.refetchEvents();
                      showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                  },
                  error: function (error) {
                    calendar.refetchEvents();
                    showToast("ì „ë‹¬ ë° ìš”ì²­ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                  },
                });
              }
            }
            trashCan.attr("hidden", true);
          },
          eventDrop: function (info) {
            let id = info.event.id;
            let localStart = new Date(info.event.start.getTime() - offset);
            let newStart = localStart.toISOString().split("T")[0];

            let data = { postDate: newStart };

            $.ajax({
              url: "/calendar/event/" + id,
              method: "PUT",
              contentType: "application/json",
              data: JSON.stringify(data),
              success: function (response) {
                if (response.success) {
                  calendar.refetchEvents();
                  showToast("ë‚ ì§œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
              },
              error: function (error) {
                calendar.refetchEvents();
                showToast("ì „ë‹¬ ë° ìš”ì²­ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              },
            });
          },
          drop: (info) => {
            const modal = new bootstrap.Modal($("#event-modal"));

            $(modal._element).on("shown.bs.modal", function (e) {
              // ì¹´í…Œê³ ë¦¬ id
              let categoryId = info.draggedEl.id.replace("category-", "");

              // ì´ë²¤íŠ¸ ë‚ ì§œ
              let date = info.dateStr;

              // ì œëª©
              $(".event-title").text("ì–´ë–»ê²Œ ì•„í”„ì‹ ê°€ìš”?");

              $(".event-date").val(date);

              $(e.target)
                .on("click", ".submit-btn", () => {
                  let data = new FormData();
                  data.append("postDate", date);
                  data.append("content", $(".event-content").val());

                  // íŒŒì¼ ì²˜ë¦¬
                  let fileInputs = $(".file-input");

                  for (let i = 0; i < fileInputs.length; i++) {
                    let file = fileInputs[i].files[0];
                    if (file) {
                      data.append("files", file);
                    }
                  }

                  $.ajax({
                    url: "/calendar/event/" + categoryId,
                    method: "POST",
                    processData: false,
                    contentType: false,
                    data: data,
                    success: (response) => {
                      if (response.success) {
                        calendar.refetchEvents();
                        modal.hide();
                        showToast("ì´ë²¤íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                      } else {
                        modal.hide();
                        showToast("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                      }
                    },
                    error: (error) => {
                      calendar.refetchEvents();
                      modal.hide();
                      showToast("ì „ë‹¬ ë° ìš”ì²­ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    },
                  });
                })
                // ì£¼ì„ from GPT-4
                // íŒŒì¼ ì„ íƒ í•„ë“œì˜ ê°’ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì…ë‹ˆë‹¤.
                .on("change", ".file-input", function () {
                  // ë§Œì•½ íŒŒì¼ì´ ì„ íƒë˜ì—ˆë‹¤ë©´
                  if ($(this).val()) {
                    // "ì‚­ì œ" ë²„íŠ¼ì„ í˜„ì¬ ìš”ì†Œ(íŒŒì¼ ì„ íƒ í•„ë“œ) ë°”ë¡œ ë’¤ì— ì¶”ê°€í•©ë‹ˆë‹¤.
                    $(this).after($("<input>").addClass("btn btn-danger remove-btn ms-1").attr({ type: "button", value: "ì‚­ì œ" }));
                  } else {
                    // íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ë‹¤ë©´,
                    // ë§Œì•½ í˜„ì¬ ìš”ì†Œê°€ ì²« ë²ˆì§¸ íŒŒì¼ ì…ë ¥ í•„ë“œê°€ ì•„ë‹ˆë¼ë©´ (ì¦‰, ì¶”ê°€ì ìœ¼ë¡œ ìƒì„±ëœ ì…ë ¥ í•„ë“œë¼ë©´)
                    if ($(this).index(".file-input") > 0) {
                      // í˜„ì¬ ìš”ì†Œë¥¼ í¬í•¨í•˜ê³  ìˆëŠ” divë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. (íŒŒì¼ ì…ë ¥ í•„ë“œ ì „ì²´ë¥¼ ì‚­ì œ)
                      $(this).parent().remove();
                    } else {
                      // ì²« ë²ˆì§¸ íŒŒì¼ ì…ë ¥ í•„ë“œë¼ë©´, í•´ë‹¹ ì…ë ¥ í•„ë“œ ë°”ë¡œ ë’¤ì˜ "ì‚­ì œ" ë²„íŠ¼ë§Œì„ ì‚­ì œí•©ë‹ˆë‹¤.
                      $(this).next(".remove-btn").remove();
                    }
                  }
                })
                // "ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì…ë‹ˆë‹¤.
                .on("click", ".add-btn", function () {
                  // ìƒˆë¡œìš´ divë¥¼ ìƒì„±í•˜ê³ , ê·¸ ì•ˆì— ìƒˆë¡œìš´ íŒŒì¼ ì…ë ¥ í•„ë“œë¥¼ ì¶”ê°€í•œ í›„,
                  // ì´ divë¥¼ '.event-file-container' í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ìš”ì†Œ ì•ˆì— ì¶”ê°€í•©ë‹ˆë‹¤.
                  $("<div>", { class: "d-flex mt-1" })
                    .append($("<input>").addClass("form-control file-input").attr({ type: "file", name: "image", accept: "image/*" }))
                    .appendTo(".event-file-container");
                })
                // 'ì‚­ì œ' ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì…ë‹ˆë‹¤.
                .on("click", ".remove-btn", function () {
                  // ë§Œì•½ í˜„ì¬ ìš”ì†Œ(ë²„íŠ¼)ê°€ ì²« ë²ˆì§¸ ë²„íŠ¼ì´ ì•„ë‹ˆë¼ë©´ (ì¦‰, ì¶”ê°€ì ìœ¼ë¡œ ìƒì„±ëœ 'ì‚­ì œ' ë²„íŠ¼ì´ë¼ë©´)
                  if ($(this).index(".btn") > 0) {
                    // í˜„ì¬ ìš”ì†Œ(ë²„íŠ¼)ì™€ í•¨ê»˜ í•´ë‹¹ ë¶€ëª¨ div ì „ì²´ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. (íŒŒì¼ ì…ë ¥ í•„ë“œ ì „ì²´ë¥¼ ì‚­ì œ)
                    $(this).parent().remove();
                  } else {
                    // ì²« ë²ˆì§¸ 'ì‚­ì œ' ë²„íŠ¼ì¸ ê²½ìš°,
                    //"change" ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì—ì„œ ì •ì˜í•œ ë¡œì§ì— ë”°ë¼ ë™ì‘í•˜ë„ë¡
                    //"change" ì´ë²¤íŠ¸ë¥¼ ê°•ì œë¡œ ë°œìƒì‹œí‚µë‹ˆë‹¤. (ì²« ë²ˆì§¸ 'ì‚­ì œ' ë²„íŠ¼ë§Œ ì‚­ì œ)
                    $(this).prev().val(null);
                    $(this).prev().trigger("change");
                  }
                });
            });

            modal.show();

            // ì‚½ì… ë¡œì§
          },
        });

        new Draggable(draggableEl, {
          itemSelector: ".draggable-item",
        });
        calendar.render();
        addHoverEffect($(".draggable-item"));
      });
    </script>
  </body>
</html>
