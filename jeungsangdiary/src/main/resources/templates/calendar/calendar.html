<!DOCTYPE html>
<html lang="en">
  <head th:replace="fragments/common :: scripts">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>calendar</title>
  </head>
  <body>
    <div th:replace="fragments/common :: header"></div>
    <div class="container">
      <div class="rounded" id="toast" hidden></div>
      <div class="row">
        <div class="col-lg-9">
          <img id="trash-can" src="https://i.imgur.com/UhIG0fh.png" hidden />
          <div id="calendar"></div>
        </div>

        <div class="modal" id="event-modal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="event-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form>
                  <div class="md-3">
                    <label for="event-date" class="col-form-label">ë‚ ì§œ</label>
                    <input type="date" class="form-control" id="event-date" />
                  </div>
                  <div class="md-3">
                    <label for="content-text" class="col-form-label">ì¦ìƒ</label>
                    <textarea class="form-control" id="content-text"></textarea>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary">ì €ì¥í•˜ê¸°</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modal" id="export-modal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="export-title">PDFë¡œ ì¶œë ¥í•˜ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form>
                  <div class="md-3">
                    <label for="export-date-start" class="col-form-label">ì‹œì‘ ë‚ ì§œ</label>
                    <input type="date" class="form-control" id="export-date-start" />
                  </div>
                  <div class="md-3">
                    <label for="export-date-end" class="col-form-label">ë ë‚ ì§œ</label>
                    <input type="date" class="form-control" id="export-date-end" />
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-success">ì¶œë ¥í•˜ê¸°</button>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-3 d-flex align-items-center">
          <div class="row" id="draggable">
            <div class="col d-flex justify-content-center align-items-center flex-column border rounded m-1 p-3 draggable-item" th:each="category : ${categories}" th:id="|category-${category.getUnqId()}|">
              <img class="category-imgs" th:src="${category.getImgUrl()}" />
              <span th:text="${category.getName()}"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div th:replace="fragments/common :: footer"></div>
    <script type="text/javascript">
      $(document).ready(function () {
        let isDrop = false;
        const offset = new Date().getTimezoneOffset() * 60000;
        const calendarEl = $("#calendar")[0];
        const draggableEl = $("#draggable")[0];
        const eventModal = $("#event-modal");
        const exportModal = $("#export-modal");
        const trashCan = $("#trash-can");
        const Draggable = FullCalendar.Interaction.Draggable;

        /**
         * ì•Œë¦¼ì°½ ë„ìš°ê¸°
         * @param message ì•Œë¦¼ì°½ì— ë„ìš¸ ë©”ì‹œì§€
         */
        const showToast = function (message) {
          let toast = $("#toast");
          toast.attr("hidden", false);
          toast.html(message);
          setTimeout(function () {
            toast.attr("hidden", true);
          }, 3000);
        };

        /**
         * ëª¨ë‹¬ ì°½ì„ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜
         * @param title ì´ë²¤íŠ¸ì˜ ì œëª©
         * @param date ì´ë²¤íŠ¸ì˜ ë‚ ì§œ
         * @param content ì´ë²¤íŠ¸ì˜ ë‚´ìš© (ì„ íƒì‚¬í•­)
         */
        function showModal(eventModal, title, date, content = "") {
          eventModal.find(".event-title").text(title);
          eventModal.find("#event-date").val(date);
          eventModal.find("#content-text").val(content);

          eventModal.modal("show");
        }

        /**
         * ë‚´ë¶€ ì´ë²¤íŠ¸ Drag & Drop ì‹œ, object ìš”ì†Œì™€ ê²¹ì³ìˆìœ¼ë©´ true ë°˜í™˜
         * @param object í´ë¦­ ì¢Œí‘œì™€ ê°™ì€ í•˜ìœ„ ìˆ˜ì¤€ ì •ë³´ê°€ í¬í•¨ëœ ê¸°ë³¸ JavaScript ì´ë²¤íŠ¸
         * @param jsEvent í´ë¦­ ì¢Œí‘œì™€ ê°™ì€ í•˜ìœ„ ìˆ˜ì¤€ ì •ë³´ê°€ í¬í•¨ëœ ê¸°ë³¸ JavaScript ì´ë²¤íŠ¸
         */
        const isElOverObject = function (object, jsEvent) {
          let ofs = object.offset();

          let x1 = ofs.left;
          let x2 = ofs.left + trashCan.outerWidth(true);
          let y1 = ofs.top;
          let y2 = ofs.top + trashCan.outerHeight(true);

          return jsEvent.pageX >= x1 && jsEvent.pageX <= x2 && jsEvent.pageY >= y1 && jsEvent.pageY <= y2;
        };

        /**
         * ë§ˆìš°ìŠ¤ë¥¼ ê°–ë‹¤ëŒ€ë©´ 1.1ë°° ë˜ëŠ” í•¨ìˆ˜
         * @param elementSelector ì…€ë ‰í„°
         */
        function addHoverEffect(elementSelector) {
          $(elementSelector).on("mouseenter", function () {
            this.classList.add("external-event-hover");
          });

          $(elementSelector).on("mouseleave", function () {
            this.classList.remove("external-event-hover");
          });
        }

        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          themeSystem: "bootstrap5",
          droppable: true,
          eventStartEditable: true,
          locale: "ko",
          googleCalendarApiKey: "AIzaSyBtgk1SVteetnW1M5HJcNL4hCqeecJ_x4M",
          headerToolbar: {
            left: "exportButton",
            center: "title",
            right: "today prev,next",
          },
          buttonText: {
            today: "ì˜¤ëŠ˜",
          },
          eventSources: [
            {
              url: "/calendar/event",
              method: "GET",
              failure: function () {
                alert("ì´ë²¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              },
            },
            {
              googleCalendarId: "ko.south_korea#holiday@group.v.calendar.google.com",
              className: "gcal-event",
            },
          ],
          customButtons: {
            exportButton: {
              text: "ì¶œë ¥í•˜ê¸°",
              click: function () {
                let today = new Date().toISOString().split("T")[0];
                $("#export-date-end").val(today);
                exportModal.modal("show");
                exportModal
                  .find(".btn-success")
                  .off()
                  .on("click", function () {
                    let startDate = $("#export-date-start").val();
                    let endDate = $("#export-date-end").val();
                    if (!startDate) {
                      $("#export-date-start").addClass("is-invalid");
                      if (!$("#start-invalid-feedback").length) {
                        $("#export-date-start").after('<div id="start-invalid-feedback" class="invalid-feedback">ì‹œì‘ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>');
                      }
                      return;
                    } else {
                      $("#export-date-start").removeClass("is-invalid");
                      $("#start-invalid-feedback").remove();
                    }
                    if (!endDate) {
                      $("#export-date-end").addClass("is-invalid");
                      if (!$("#end-invalid-feedback").length) {
                        $("#export-date-end").after('<div id="end-invalid-feedback" class="invalid-feedback">ë ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>');
                      }
                      return;
                    } else {
                      $("#export-date-end").removeClass("is-invalid");
                      $("#end-invalid-feedback").remove();
                    }

                    $.ajax({
                      url: "/calendar/event",
                      method: "GET",
                      success: function (ajaxData) {
                        let filteredData = ajaxData
                          .filter(function (item) {
                            let itemDate = new Date(item.start);
                            return itemDate >= new Date(startDate) && itemDate <= new Date(endDate);
                          })
                          .map(function (item) {
                            return {
                              ë‚ ì§œ: item.start,
                              ëŒ€ë¶„ë¥˜: item.title,
                              ì¦ìƒ: item.content,
                            };
                          });

                        // excel íŒŒì¼ë¡œ ì €ì¥
                        let wb = XLSX.utils.book_new();
                        let ws = XLSX.utils.json_to_sheet(filteredData);

                        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

                        let wbout = XLSX.write(wb, { bookType: "xlsx", type: "binary" });

                        function s2ab(s) {
                          let buf = new ArrayBuffer(s.length);
                          let view = new Uint8Array(buf);
                          for (var i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xff;
                          return buf;
                        }

                        saveAs(new Blob([s2ab(wbout)], { type: "application/octet-stream" }), "text.xlsx");
                      },
                      error: function (error) {
                        console.log("ğŸš€ ~ file: calendar.html:175 ~ error:", error);
                      },
                    });
                  });
              },
            },
          },
          eventClick: function (info) {
            let id = info.event.id;
            let title = info.event.title;
            let localStart = new Date(info.event.start.getTime() - offset);

            let start = localStart.toISOString().split("T")[0];
            let content = info.event.extendedProps.content;

            isDrop = false;
            showModal(eventModal, title, start, content);
            modalEventHandeler(info);
          },
          eventMouseEnter: function (info) {
            info.el.classList.add("event-hover");
          },
          eventMouseLeave: function (info) {
            info.el.classList.remove("event-hover");
          },
          eventDragStart: function (info) {
            trashCan.attr("hidden", false);
          },
          eventDragStop: function (info) {
            info.el.classList.remove("event-hover");
            if (isElOverObject(trashCan, info.jsEvent)) {
              if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                trashCan.attr("hidden", true);
                let id = info.event.id;
                $.ajax({
                  url: "/calendar/delete/" + id,
                  method: "DELETE",
                  success: function (response) {
                    if (response.success) {
                      info.event.remove();
                      showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                      calendar.refetchEvents();
                    }
                  },
                  error: function (error) {
                    console.log("ajax error");
                  },
                });
              }
            }
            trashCan.attr("hidden", true);
          },
          eventDrop: function (info) {
            let id = info.event.id;
            let localStart = new Date(info.event.start.getTime() - offset);
            let newStart = localStart.toISOString().split("T")[0];
            let data = {
              postDate: newStart,
            };
            $.ajax({
              url: "/calendar/event/" + id,
              method: "PUT",
              contentType: "application/json",
              data: JSON.stringify(data),
              success: function (response) {
                if (response.success) {
                  showToast("ë‚ ì§œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                  calendar.refetchEvents();
                }
              },
              error: function (error) {},
            });
          },
          //ì™¸ë¶€ ì´ë²¤íŠ¸ê°€ Drop ë  ë•Œ
          drop: function (info) {
            let title = info.draggedEl.innerText;
            let date = info.dateStr;

            isDrop = true;
            showModal(eventModal, title, date);
            modalEventHandeler(info);
          },
        });

        const modalEventHandeler = function (info) {
          eventModal
            .find(".btn-primary")
            .off()
            .on("click", function () {
              let date = eventModal.find("#event-date").val();
              let contetnt = eventModal.find("#content-text").val();
              let data = {
                postDate: date,
                content: contetnt,
              };
              if (isDrop) {
                // ì‚½ì… ë¡œì§
                let categoryId = info.draggedEl.id.replace("category-", "");
                $.ajax({
                  url: "/calendar/event/" + categoryId,
                  method: "POST",
                  contentType: "application/json",
                  data: JSON.stringify(data),
                  success: function (response) {
                    if (response.success) {
                      calendar.refetchEvents();
                      showToast("ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else {
                      console.log("ì„œë²„ì—ì„œ ì‘ë‹µì´ ì„±ê³µì ì´ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    }

                    eventModal.modal("hide");
                  },
                  error: function (error) {
                    console.log("AJAX ìš”ì²­ ì—ëŸ¬: ", error);
                    eventModal.modal("hide");
                  },
                });
              } else {
                // ìˆ˜ì • ë¡œì§
                let cellId = info.event.id;
                $.ajax({
                  url: "/calendar/update/" + cellId,
                  method: "PUT",
                  contentType: "application/json",
                  data: JSON.stringify(data),
                  success: function (response) {
                    if (response.success) {
                      calendar.refetchEvents();
                      showToast("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else {
                      console.log("ì„œë²„ì—ì„œ ì‘ë‹µì´ ì„±ê³µì ì´ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    }

                    eventModal.modal("hide");
                  },
                  error: function (error) {
                    console.log("AJAX ìš”ì²­ ì—ëŸ¬: ", error);
                    eventModal.modal("hide");
                  },
                });
              }
            });
        };

        new Draggable(draggableEl, {
          itemSelector: ".draggable-item",
        });
        calendar.render();
        addHoverEffect($(".draggable-item"));
      });
    </script>
  </body>
</html>
