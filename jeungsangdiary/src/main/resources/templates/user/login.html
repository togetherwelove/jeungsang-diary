<!DOCTYPE html>
<html lang="en">
  <head>
    <div th:replace="fragments/common :: scripts"></div>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>login</title>
  </head>
  <body>
    <div th:replace="fragments/common :: header"></div>
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <div class="wrapper">
            <div class="card">
              <div class="card-header">
                <h1 class="fs-3">로그인</h1>
                <p>캘린더 기능을 이용하시려면 로그인이 필요합니다.</p>
              </div>
              <form class="login-form needs-validation" action="/login" method="post" novalidate>
                <ul class="list-group list-group-flush">
                  <li class="list-group-item">
                    <label>이메일</label>
                    <input class="form-control" type="email" name="email" />
                    <label>비밀번호</label>
                    <input class="form-control" type="password" name="password" />
                  </li>
                </ul>
                <div class="card-body d-flex justify-content-end">
                  <input class="btn btn-lg btn-primary" type="submit" value="로그인" />
                </div>
              </form>
            </div>
          </div>
          <div class="col-md-6"></div>
        </div>
      </div>
    </div>
    <div th:replace="fragments/common :: footer"></div>
    <script>
      $(document).ready(function () {
        $(".login-form").on("submit", function (e) {
          e.preventDefault();

          let data = $(this).serialize();

          $.ajax({
            url: "/login",
            method: "POST",
            data: data,
            traditional: true,
            success: function (response) {
              window.history.back();
              alert(`로그인 성공\n${response}님, 반갑습니다.`);
            },
            error: function (jqXHR, textStatus, errorThown) {
              let responseText = jqXHR.responseText;
              let errors = JSON.parse(responseText);

              $(".invalid-feedback").remove();
              $("input.is-invalid").removeClass("is-invalid");

              for (let i = 0; i < errors.length; i++) {
                let error = errors[i];

                if (error.field === "notmatched") {
                  showToast(error.message);
                }

                let inputField = $("input[name='" + error.field + "']");
                if (inputField.length > 0) {
                  let invalidFeedbackDiv = $("<div>", { class: "invalid-feedback" }).text(error.message);

                  inputField.addClass("is-invalid");
                  invalidFeedbackDiv.insertAfter(inputField);
                }
              }
            },
          });
        });
      });
    </script>
  </body>
</html>
