<!DOCTYPE html>
<html lang="en">
  <head>
    <div th:replace="fragments/common :: scripts"></div>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>join</title>
  </head>
  <body>
    <div th:replace="fragments/common :: header"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-6"></div>
        <div class="col-lg-6">
          <div class="wrapper">
            <div class="card">
              <div class="card-header d-flex justify-content-between">
                <div>
                  <h1 class="fs-3">회원가입</h1>
                  <p>간단하게 회원가입을 진행하세요.</p>
                </div>
                <div class="fs-3"><span></span></div>
              </div>
              <form class="join-form needs-validation" novalidate>
                <ul class="list-group list-group-flush">
                  <li class="list-group-item">
                    <label>닉네임</label>
                    <input class="form-control" type="text" name="username" />
                  </li>
                  <li class="list-group-item">
                    <label>이메일</label>
                    <input class="form-control" type="email" name="email" />
                  </li>
                  <li class="list-group-item">
                    <label>비밀번호</label>
                    <input class="form-control" type="password" name="password" />
                    <label>비밀번호 확인</label>
                    <input class="form-control" type="password" name="passwordCheck" />
                  </li>
                </ul>
                <div class="card-body d-flex justify-content-end">
                  <input class="btn btn-lg btn-primary" type="submit" value="가입하기" />
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div th:replace="fragments/common :: footer"></div>
  </body>
  <script>
    $(document).ready(function () {
      $(".join-form").on("submit", function (e) {
        e.preventDefault();
        let data = $(this).serialize();

        $.ajax({
          url: "join",
          method: "POST",
          data: data,
          success: function (response) {
            // 회원가입 성공 시
            window.location = "user/login";
          },
          error: function (jqXHR, textStatus, errorThown) {
            let responseText = jqXHR.responseText;
            let errors = JSON.parse(responseText);

            $(".invalid-feedback").remove();
            $("input.is-invalid").removeClass("is-invalid");

            let handledField = {};

            for (let i = 0; i < errors.length; i++) {
              let error = errors[i];

              if (handledField[error.field]) continue;

              let inputField = $("input[name='" + error.field + "']");
              if (inputField.length > 0) {
                let invalidFeedbackDiv = $("<div>", { class: "invalid-feedback" }).text(error.message);

                inputField.addClass("is-invalid");
                invalidFeedbackDiv.insertAfter(inputField);

                handledField[error.field] = true;
              }
            }
          },
        });
      });
    });
  </script>
</html>
